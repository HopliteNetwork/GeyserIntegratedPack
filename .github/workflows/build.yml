name: Build & Deploy GeyserIntegratedPack
on:
  push:
    branches:
      - 'main'
  schedule:
    - cron: '15 3 * * 1'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: pip install awscli

      - name: Build mcpack
        run: |
          mkdir dist
          cd src/main/resources/integratedpack
          zip -r ../../../../dist/GeyserIntegratedPack.mcpack ./*

      - name: Deploy to Cloudflare R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.CF_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.CF_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
        run: |
          PACK_SIZE=$(stat -c%s "dist/GeyserIntegratedPack.mcpack")

          aws s3 cp "dist/GeyserIntegratedPack.mcpack" "s3://${{ secrets.CF_R2_BUCKET }}/bedrock-gip/GeyserIntegratedPack.mcpack" \
            --endpoint-url "https://${{ secrets.CF_ACCOUNT_ID }}.r2.cloudflarestorage.com" \
            --content-type "application/zip" \
            --cache-control "public, max-age=31536000"

          echo "Uploaded: GeyserIntegratedPack.mcpack ($PACK_SIZE bytes)"
