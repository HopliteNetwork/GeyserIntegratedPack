name: Build & Deploy GeyserIntegratedPack
on:
  push:
    branches:
      - 'master'
    paths-ignore:
      - '.gitignore'
      - 'LICENSE'
      - 'README.md'
  schedule:
    - cron: '15 3 * * 1'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Gradle
        uses: GeyserMC/actions/setup-gradle-composite@master
        with:
          setup-java_java-version: 21

      - name: Build with Gradle
        run: ./gradlew run

      - name: Install AWS CLI
        run: pip install awscli

      - name: Deploy to Cloudflare R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.CF_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.CF_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
        run: |
          PACK_SIZE=$(stat -c%s "GeyserIntegratedPack.mcpack")

          aws s3 cp "GeyserIntegratedPack.mcpack" "s3://${{ secrets.CF_R2_BUCKET }}/bedrock-gip/GeyserIntegratedPack.mcpack" \
            --endpoint-url "https://${{ secrets.CF_ACCOUNT_ID }}.r2.cloudflarestorage.com" \
            --content-type "application/zip" \
            --cache-control "public, max-age=31536000"

          echo "Uploaded: GeyserIntegratedPack.mcpack ($PACK_SIZE bytes)"
